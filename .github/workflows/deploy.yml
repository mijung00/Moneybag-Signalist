name: Deploy to AWS Elastic Beanstalk

on:
  # 1. 'main' 브랜치에 푸시될 때 (웹/워커 자동 배포용)
  push:
    branches:
      - main
  # 2. GitHub Actions 탭에서 수동으로 실행할 수 있도록 함 (왓치독 배포용)
  workflow_dispatch:

jobs:
  # ====================================================================
  # JOB 1: 웹 & 작업자 환경 자동 배포
  # ====================================================================
  deploy-app:
    runs-on: ubuntu-latest
    # 'main' 브랜치에 푸시되었을 때만 이 Job을 실행합니다.
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout source code
        uses: actions/checkout@v3

      - name: Generate deployment package
        run: |
          zip -r deploy.zip . \
            -x "*.git*" \
            -x "*.github*" \
            -x "Procfile.watchdog"
      
      - name: Deploy to Web Environment
        uses: einaregilsson/beanstalk-deploy@v21
        with:
          aws_access_key: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          application_name: fincore_ds
          environment_name: Fincoreds-env-1 # 웹 환경
          version_label: ${{ github.sha }}
          region: ap-northeast-2
          deployment_package: deploy.zip

      - name: Deploy to Worker Environment
        uses: einaregilsson/beanstalk-deploy@v21
        with:
          aws_access_key: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          application_name: fincore_ds
          environment_name: Fincoreds-env-worker-real # 작업자 환경
          version_label: ${{ github.sha }}
          region: ap-northeast-2
          deployment_package: deploy.zip

  # ====================================================================
  # JOB 2: 왓치독 환경 수동 배포
  # =================================G===================================
  deploy-watchdog:
    runs-on: ubuntu-latest
    # '수동 실행'일 경우에만 이 Job을 실행합니다.
    if: github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout source code
        uses: actions/checkout@v3

      - name: Prepare Procfile for Watchdog
        run: mv Procfile.watchdog Procfile

      - name: Generate deployment package for Watchdog
        run: |
          zip -r deploy.zip . \
            -x "*.git*" \
            -x "*.github*" \
            -x "Procfile.watchdog"

      - name: Deploy to Watchdog Environment
        uses: einaregilsson/beanstalk-deploy@v21
        with:
          aws_access_key: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          application_name: fincore_ds
          environment_name: Fincoreds-env-watchdog-real # 왓치독 환경
          version_label: "watchdog-${{ github.sha }}"
          region: ap-northeast-2
          deployment_package: deploy.zip