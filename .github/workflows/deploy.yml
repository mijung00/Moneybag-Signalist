name: Deploy to AWS Elastic Beanstalk

on:
  push:
    branches:
      - main # 'main' 브랜치에 푸시될 때만 실행

jobs:
  # ----------------------------------------------------
  # [STEP 1] Build: 배포용 압축 파일을 한 번만 생성합니다.
  # ----------------------------------------------------
  build:
    runs-on: ubuntu-latest
    steps:
      # 1. 깃허브에 있는 코드 내려받기
      - name: Checkout source code
        uses: actions/checkout@v3

      # 2. 배포용 압축파일 만들기 (기존과 동일)
      - name: Generate deployment package
        run: |
          zip -r deploy.zip . \
          -x "*.git*" \
          -x "*.github*" \
          -x "venv/*" \
          -x "keys/*" \
          -x "secrets/*" \
          -x "*.pem" \
          -x "__pycache__/*" \
          -x "*.DS_Store" \
          -x ".env" \
          -x "iceage/data/*" \
          -x "moneybag/data/*" \
          -x "*.csv" \
          -x "*.jsonl"

      # 3. 생성된 압축파일을 다른 Job에서 쓸 수 있도록 업로드
      - name: Upload artifact for deployment jobs
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package
          path: deploy.zip

  # ----------------------------------------------------
  # [STEP 2-1] Deploy Worker: 작업자(Worker) 환경에 배포
  # ----------------------------------------------------
  deploy-worker-environment:
    runs-on: ubuntu-latest
    needs: build # build 작업이 성공해야 실행됨
    steps:
      - name: Download artifact from build job
        uses: actions/download-artifact@v4
        with:
          name: deployment-package

      - name: Deploy to Worker Environment
        uses: einaregilsson/beanstalk-deploy@v21
        with:
          aws_access_key: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          application_name: fincore_ds
          environment_name: Fincoreds-env-worker-real # 작업자 환경
          version_label: ${{ github.sha }}
          region: ap-northeast-2
          deployment_package: deploy.zip
          wait_for_deployment: true
          wait_for_environment_recovery: 300

  # ----------------------------------------------------
  # [STEP 2-2] Deploy User: 사용자(Web) 환경에 배포
  # ----------------------------------------------------
  deploy-user-environment:
    runs-on: ubuntu-latest
    needs: build # build 작업이 성공해야 실행됨
    steps:
      - name: Download artifact from build job
        uses: actions/download-artifact@v4
        with:
          name: deployment-package

      - name: Deploy to User Environment
        uses: einaregilsson/beanstalk-deploy@v21
        with:
          aws_access_key: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          application_name: fincore_ds
          environment_name: Fincoreds-env-1 # 사용자 웹 환경
          version_label: ${{ github.sha }}
          region: ap-northeast-2
          deployment_package: deploy.zip
          wait_for_deployment: true
          wait_for_environment_recovery: 300