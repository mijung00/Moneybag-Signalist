{% extends "base.html" %}

{% block content %}
<div class="flex justify-between items-center mb-8">
    <div class="overflow-hidden"> <!-- [추가] 자식 요소의 스타일 유출로 인한 레이아웃 깨짐 방지 -->
        <h1 class="text-3xl font-bold text-gray-900 no-underline">{{ display_name }}</h1>
        <p class="text-gray-500 mt-1">{{ date_str }} 리포트</p>
    </div>
    <div class="flex items-center space-x-2">
        <a href="{{ url_for('archive_view', service_name=service_name, date_str=prev_date) }}" class="px-3 py-2 rounded-md bg-white border border-gray-300 text-sm font-medium text-gray-700 hover:bg-gray-50">&larr; 이전</a>
        <a href="{{ url_for('archive_view', service_name=service_name, date_str=next_date) }}" class="px-3 py-2 rounded-md bg-white border border-gray-300 text-sm font-medium text-gray-700 hover:bg-gray-50 {% if date_str >= today_str %}opacity-50 cursor-not-allowed pointer-events-none{% endif %}">다음 &rarr;</a>
    </div>
</div>

{% if is_locked %}
    <!-- 잠금 화면 -->
    <div class="relative">
        <!-- [수정] 스타일 유출을 막기 위해 잠금 화면의 배경도 iframe으로 처리하고, 블러 효과를 직접 적용 -->
        {% if content_html %}
        <iframe srcdoc="{{ content_html|e }}" 
                class="w-full h-[80vh] border-none select-none opacity-50 blur-sm"
                sandbox="allow-same-origin">
        </iframe>
        {% else %}
        <div class="text-center py-20 bg-gray-50 rounded-lg select-none opacity-50 blur-sm">
            <p class="text-gray-500">리포트가 없습니다.</p>
        </div>
        {% endif %}

        <!-- 잠금 해제 UI -->
        <!-- [수정] 배경 iframe에 직접 blur를 적용했으므로, 여기서는 backdrop-blur를 제거하고 반투명 오버레이 역할만 수행 -->
        <div class="absolute inset-0 bg-white/80"></div>
        <div class="absolute top-0 left-0 right-0 flex items-start justify-center pt-24 z-10"> <!-- 이 컨테이너는 블러의 영향을 받지 않음 -->
            <div class="text-center bg-white p-8 rounded-lg shadow-2xl border max-w-md w-full relative"> {# 폼 자체는 z-index를 가질 필요가 없습니다 #}
                <i class="fas fa-lock text-4xl text-gray-400 mb-4"></i>
                <h2 class="text-xl font-bold mb-2">최신 리포트입니다</h2>
                <p class="text-gray-600 mb-6">구독자에게만 먼저 공개됩니다.<br>이메일을 입력하고 지금 바로 확인해보세요.</p>
                <form action="{{ url_for('index') }}" method="POST">
                    <input type="hidden" name="action" value="unlock">
                    <input type="hidden" name="service_name" value="{{ service_name }}">
                    <input type="hidden" name="date_str" value="{{ date_str }}">
                    <div class="flex items-center space-x-2 mb-4">
                        <input type="email" name="email" required class="flex-grow w-full px-4 py-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="이메일 주소">
                        <button type="submit" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-md hover:bg-blue-700 transition-colors">
                            리포트 받기
                        </button>
                    </div>
                    <div class="text-xs text-gray-500">
                        <label for="unlock_agree_terms" class="flex items-center justify-center">
                            <input id="unlock_agree_terms" name="agree_terms" type="checkbox" required class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <span class="ml-2">개인정보 수집 및 이용에 동의합니다.</span>
                        </label>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% elif content_html %}
    <!-- 리포트 본문 -->
    <iframe id="report-iframe" srcdoc="{{ content_html|e }}" style="width: 100%; border: none; min-height: 80vh;"
            onload="this.style.height=(this.contentWindow.document.body.scrollHeight + 40) + 'px';"
            sandbox="allow-same-origin">
    </iframe>

{% else %}
    <!-- 콘텐츠 없음 -->
    <div class="text-center py-20 bg-gray-50 rounded-lg">
        <i class="fas fa-file-alt text-4xl text-gray-400 mb-4"></i>
        <h2 class="text-xl font-bold mb-2">리포트가 없습니다</h2>
        <p class="text-gray-500">선택하신 날짜의 리포트를 찾을 수 없습니다.</p>
    </div>
{% endif %}
{% endblock %}

{% block scripts %}
{% if not is_locked and content_html %}
<script>
// iframe 내부의 공유/구독 버튼은 해당 iframe의 컨텍스트에서 동작하므로,
// 이 페이지의 스크립트는 더 이상 필요하지 않습니다.
// 링크 복사 등의 기능은 base.html에 전역으로 정의되어 있어 iframe 내부에서도 호출 가능합니다.
document.addEventListener('DOMContentLoaded', function() {
    // iframe 높이 조절 로직이 onload에 있으므로 추가 스크립트는 불필요합니다.
});
</script>
{% endif %}
{% endblock %}