{% extends "base.html" %}

{% block content %}
<div class="flex justify-between items-center mb-8">
    <div>
        <h1 class="text-3xl font-bold">{{ display_name }}</h1>
        <p class="text-gray-500 mt-1">{{ date_str }} 리포트</p>
    </div>
    <div class="flex items-center space-x-2">
        <a href="{{ url_for('archive_view', service_name=service_name, date_str=prev_date) }}" class="px-3 py-2 rounded-md bg-white border border-gray-300 text-sm font-medium text-gray-700 hover:bg-gray-50">&larr; 이전</a>
        <a href="{{ url_for('archive_view', service_name=service_name, date_str=next_date) }}" class="px-3 py-2 rounded-md bg-white border border-gray-300 text-sm font-medium text-gray-700 hover:bg-gray-50 {% if date_str >= today_str %}opacity-50 cursor-not-allowed pointer-events-none{% endif %}">다음 &rarr;</a>
    </div>
</div>

{% if is_locked %}
    <!-- 잠금 화면 -->
    <div class="relative">
        <!-- 배경 콘텐츠 (이제 직접 블러 처리하지 않음) -->
        {% if content_html %}
        <div class="select-none opacity-50">
            {{ content_html|safe }}
        </div>
        {% else %}
        <div class="text-center py-20 bg-gray-50 rounded-lg select-none opacity-50">
            <p class="text-gray-500">리포트가 없습니다.</p>
        </div>
        {% endif %}

        <!-- 잠금 해제 UI -->
        <div class="absolute inset-0 bg-white/80 backdrop-blur-sm"></div> {# 배경 오버레이와 블러 효과를 이 div 하나로 처리 #}
        <div class="absolute top-0 left-0 right-0 flex items-start justify-center pt-24 z-10">
            <div class="text-center bg-white p-8 rounded-lg shadow-2xl border max-w-md w-full relative"> {# 폼 자체는 z-index를 가질 필요가 없습니다 #}
                <i class="fas fa-lock text-4xl text-gray-400 mb-4"></i>
                <h2 class="text-xl font-bold mb-2">최신 리포트입니다</h2>
                <p class="text-gray-600 mb-6">구독자에게만 먼저 공개됩니다.<br>이메일을 입력하고 지금 바로 확인해보세요.</p>
                <form action="{{ url_for('index') }}" method="POST">
                    <input type="hidden" name="action" value="unlock">
                    <input type="hidden" name="service_name" value="{{ service_name }}">
                    <input type="hidden" name="date_str" value="{{ date_str }}">
                    <div class="flex items-center space-x-2 mb-4">
                        <input type="email" name="email" required class="flex-grow w-full px-4 py-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="이메일 주소">
                        <button type="submit" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-md hover:bg-blue-700 transition-colors">
                            리포트 받기
                        </button>
                    </div>
                    <div class="text-xs text-gray-500">
                        <label for="unlock_agree_terms" class="flex items-center justify-center">
                            <input id="unlock_agree_terms" name="agree_terms" type="checkbox" required class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <span class="ml-2">개인정보 수집 및 이용에 동의합니다.</span>
                        </label>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% elif content_html %}
    <!-- 리포트 본문 -->
    <div>
        {{ content_html|safe }}
    </div>

    <!-- [NEW] 공유하기 버튼 -->
    {% include '_share_buttons.html' %}

    <!-- [NEW] 구독 유도 CTA -->
    {% include '_subscribe_cta.html' %}

{% else %}
    <!-- 콘텐츠 없음 -->
    <div class="text-center py-20 bg-gray-50 rounded-lg">
        <i class="fas fa-file-alt text-4xl text-gray-400 mb-4"></i>
        <h2 class="text-xl font-bold mb-2">리포트가 없습니다</h2>
        <p class="text-gray-500">선택하신 날짜의 리포트를 찾을 수 없습니다.</p>
    </div>
{% endif %}
{% endblock %}

{% block scripts %}
{% if not is_locked and content_html %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const kakaoBtn = document.getElementById('kakao-share-btn');
    if (kakaoBtn) {
        kakaoBtn.addEventListener('click', () => {
            shareOnKakao(
                "{{ page_title | e }}",
                "{{ page_description | e }}",
                "{{ url_for('static', filename='images/og_image.png', _external=True) }}",
                "{{ request.url }}"
            );
        });
    }

    const copyBtn = document.getElementById('copy-link-btn');
    if (copyBtn) {
        copyBtn.addEventListener('click', copyCurrentUrl);
    }
});
</script>
{% endif %}
{% endblock %}